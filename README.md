# üõçÔ∏è Integraci√≥n Shopify - Salesforce

Una integraci√≥n completa y robusta entre Shopify y Salesforce que permite sincronizar productos, clientes y √≥rdenes de manera bidireccional usando objetos nativos de Salesforce.

## üìã Tabla de Contenidos

- [üéØ Caracter√≠sticas Principales](#-caracter√≠sticas-principales)
- [üèóÔ∏è Arquitectura del Sistema](#Ô∏è-arquitectura-del-sistema)
- [üì¶ Componentes del Proyecto](#-componentes-del-proyecto)
- [‚öôÔ∏è Configuraci√≥n e Instalaci√≥n](#Ô∏è-configuraci√≥n-e-instalaci√≥n)
- [üöÄ Uso del Sistema](#-uso-del-sistema)
- [üîß API y M√©todos](#-api-y-m√©todos)
- [üìä Objetos y Campos Personalizados](#-objetos-y-campos-personalizados)
- [üîÑ Flujo de Sincronizaci√≥n](#-flujo-de-sincronizaci√≥n)
- [üõ†Ô∏è Desarrollo y Testing](#Ô∏è-desarrollo-y-testing)
- [üìà Monitoreo y Logs](#-monitoreo-y-logs)
- [üîí Seguridad](#-seguridad)
- [‚ùì Troubleshooting](#-troubleshooting)
- [üìù Changelog](#-changelog)

## üéØ Caracter√≠sticas Principales

### ‚ú® Funcionalidades Core
- **üîÑ Sincronizaci√≥n Bidireccional**: Productos, clientes y √≥rdenes entre Shopify y Salesforce
- **üí∞ Precios Reales**: Extracci√≥n autom√°tica de precios reales de Shopify con Price Book Entries
- **üè¢ Objetos Nativos**: Uso de objetos est√°ndar de Salesforce (Product2, Account, Contact, Order)
- **üì± Interfaz Moderna**: Lightning Web Components con dise√±o responsivo
- **üîß Configuraci√≥n Flexible**: Credenciales y configuraciones centralizadas
- **üìä Dashboard Completo**: Panel de control para gesti√≥n de sincronizaci√≥n
- **üßπ Limpieza de Datos**: Herramientas para limpiar datos de prueba

### üöÄ Ventajas T√©cnicas
- **GraphQL API**: Uso de la API moderna de Shopify para mejor rendimiento
- **Manejo de Errores**: Sistema robusto de manejo de errores y logging
- **Transacciones Seguras**: Gesti√≥n adecuada de transacciones DML
- **Escalabilidad**: Dise√±o preparado para grandes vol√∫menes de datos
- **Mantenibilidad**: C√≥digo bien documentado y modular

## üèóÔ∏è Arquitectura del Sistema

```mermaid
graph TB
    A[Shopify Store] -->|GraphQL API| B[Salesforce Org]
    B -->|Webhooks| A
    
    subgraph "Salesforce Components"
        C[ShopifyDataController]
        D[ShopifySyncService]
        E[ShopifyToCoreMapper]
        F[ShopifyWebhookHandler]
        G[Lightning Web Components]
    end
    
    subgraph "Native Salesforce Objects"
        H[Product2]
        I[Account]
        J[Contact]
        K[Order]
        L[PricebookEntry]
    end
    
    C --> D
    D --> E
    E --> H
    E --> I
    E --> J
    E --> K
    E --> L
    G --> C
    F --> C
```

## üì¶ Componentes del Proyecto

### üîß Apex Classes

#### `ShopifyDataController.cls`
**Controlador principal** que maneja toda la l√≥gica de negocio y comunicaci√≥n con Shopify.

**M√©todos Principales:**
- `syncProductsOnly()` - Sincronizaci√≥n de productos con precios reales
- `syncCustomersOnly()` - Sincronizaci√≥n de clientes a Account + Contact
- `syncOrdersOnly()` - Sincronizaci√≥n de √≥rdenes
- `syncHistoricalDataFromShopify()` - Sincronizaci√≥n completa
- `limpiarBaseDeDatos()` - Limpieza de datos existentes
- `getShopifyProducts()` - Consulta de productos (LWC)
- `getShopifyCustomers()` - Consulta de clientes (LWC)
- `getShopifyOrders()` - Consulta de √≥rdenes (LWC)

#### `ShopifySyncService.cls`
**Servicio de sincronizaci√≥n** que maneja la l√≥gica de mapeo y sincronizaci√≥n de datos.

**Funcionalidades:**
- Sincronizaci√≥n de clientes a Account + Contact
- Sincronizaci√≥n de productos con Price Book Entries
- Sincronizaci√≥n de √≥rdenes
- Limpieza de datos de Shopify
- Gesti√≥n de relaciones entre objetos

#### `ShopifyToCoreMapper.cls`
**Mapeador de datos** que convierte datos de Shopify a objetos nativos de Salesforce.

**M√©todos de Mapeo:**
- `mapCustomerToAccount()` - Cliente ‚Üí Account
- `mapCustomerToContact()` - Cliente ‚Üí Contact
- `mapProductToProduct2()` - Producto ‚Üí Product2
- `createPricebookEntry()` - Crear Price Book Entry
- `mapOrderToOrder()` - Orden ‚Üí Order
- `extractFirstVariantPrice()` - Extraer precio de variante

#### `ShopifyWebhookHandler.cls`
**Manejador de webhooks** para recibir notificaciones de Shopify en tiempo real.

### üé® LWC - Lightning Web Components

#### `shopifyDashboard`
**Panel de control principal** para gesti√≥n de la integraci√≥n.

**Caracter√≠sticas:**
- Estado de conexi√≥n en tiempo real
- Botones de sincronizaci√≥n individual y completa
- Herramientas de limpieza de datos
- Informaci√≥n de configuraci√≥n

#### `shopifyProducts`
**Gesti√≥n de productos** sincronizados desde Shopify.

**Funcionalidades:**
- Lista de productos con precios reales
- Filtros por estado y categor√≠a
- Formateo de moneda (COP)
- Acciones de vista y edici√≥n

#### `shopifyCustomers`
**Gesti√≥n de clientes** sincronizados desde Shopify.

**Funcionalidades:**
- Lista de clientes con informaci√≥n completa
- Filtros por nombre y email
- Gesti√≥n de cuentas y contactos
- Acciones de vista y edici√≥n

#### `shopifyOrders`
**Gesti√≥n de √≥rdenes** sincronizadas desde Shopify.

**Funcionalidades:**
- Lista de √≥rdenes con estados
- Filtros por estado y cliente
- Formateo de fechas y montos
- Acciones de vista y edici√≥n

### üîó Configuraciones

#### Named Credentials
- **Shopify_API**: Credenciales para autenticaci√≥n con Shopify

#### Remote Site Settings
- **Shopify_Integration**: Configuraci√≥n de sitio remoto para Shopify
- **Shopify_Remote_Site**: Configuraci√≥n adicional de sitio remoto

#### Custom Fields
- **Product2.ShopifyProductId__c**: ID √∫nico del producto en Shopify
- **Account.ShopifyCustomerId__c**: ID √∫nico del cliente en Shopify
- **Contact.ShopifyCustomerId__c**: ID √∫nico del cliente en Shopify
- **Order.ShopifyOrderId__c**: ID √∫nico de la orden en Shopify
- **Order.ShopifyOrderNumber__c**: N√∫mero de orden de Shopify
- **Order.ShopifyTotalAmount__c**: Monto total de la orden
- **Order.ShopifyFinancialStatus__c**: Estado financiero de la orden

## ‚öôÔ∏è Configuraci√≥n e Instalaci√≥n

### üìã Prerrequisitos

- **Salesforce Org**: Developer Edition o superior
- **Shopify Store**: Tienda activa con acceso a Admin API
- **SFDX CLI**: Herramientas de desarrollo de Salesforce
- **Node.js**: Para herramientas de desarrollo (opcional)

### üöÄ Instalaci√≥n

1. **Clonar el repositorio:**
```bash
git clone <repository-url>
cd shopify-salesforce-integration
```

2. **Configurar Salesforce CLI:**
```bash
sf org login web --alias shopifyOrg
```

3. **Desplegar el proyecto:**
```bash
sf project deploy start --target-org shopifyOrg
```

4. **Configurar credenciales de Shopify:**
   - Editar `ShopifyDataController.cls`
   - Actualizar `shopDomain` y `apiKey`
   - Actualizar `webhookSecret`

5. **Configurar Remote Site Settings:**
   - Verificar que las URLs de Shopify est√©n permitidas
   - Configurar Named Credentials si es necesario

### üîß Configuraci√≥n de Shopify

1. **Crear Private App en Shopify:**
   - Ir a Settings ‚Üí Apps and sales channels
   - Crear Private App
   - Configurar permisos de Admin API
   - Obtener Access Token

2. **Configurar Webhooks (Opcional):**
   - Configurar webhooks para eventos de productos, clientes y √≥rdenes
   - URL del webhook: `https://tu-org.salesforce.com/services/apexrest/shopify/webhook`

## üöÄ Uso del Sistema

### üìä Dashboard Principal

1. **Acceder al Dashboard:**
   - Navegar a la p√°gina donde est√° desplegado el componente `shopifyDashboard`
   - Verificar estado de conexi√≥n

2. **Sincronizaci√≥n de Datos:**
   - **Limpiar Base de Datos**: Eliminar datos existentes antes de sincronizar
   - **Sincronizar Productos**: Sincronizar productos con precios reales
   - **Sincronizar Clientes**: Sincronizar clientes a Account + Contact
   - **Sincronizar √ìrdenes**: Sincronizar √≥rdenes
   - **Sincronizar Todo**: Sincronizaci√≥n completa de todos los datos

### üîÑ Flujo de Sincronizaci√≥n

#### Sincronizaci√≥n de Productos
1. **Obtener moneda** de la tienda Shopify
2. **Extraer productos** usando GraphQL API
3. **Obtener precios reales** de las variantes
4. **Crear/Actualizar Product2** en Salesforce
5. **Crear Price Book Entries** con precios reales

#### Sincronizaci√≥n de Clientes
1. **Extraer clientes** usando GraphQL API
2. **Crear/Actualizar Account** para cada cliente
3. **Crear/Actualizar Contact** asociado al Account
4. **Mantener relaciones** entre Account y Contact

#### Sincronizaci√≥n de √ìrdenes
1. **Extraer √≥rdenes** usando GraphQL API
2. **Buscar Account** por email del cliente
3. **Crear/Actualizar Order** en Salesforce
4. **Asociar Order** con Account correspondiente

## üîß API y M√©todos

### üì° GraphQL Queries

#### Productos
```graphql
{
  products(first: 10) {
    edges {
      node {
        id
        title
        handle
        productType
        status
        description
        tags
        variants(first: 1) {
          edges {
            node {
              price
            }
          }
        }
      }
    }
  }
}
```

#### Clientes
```graphql
{
  customers(first: 50) {
    edges {
      node {
        id
        firstName
        lastName
        email
        phone
      }
    }
  }
}
```

#### √ìrdenes
```graphql
{
  orders(first: 50) {
    edges {
      node {
        id
        orderNumber
        totalPriceSet {
          shopMoney {
            amount
          }
        }
        financialStatus
        email
        createdAt
      }
    }
  }
}
```

### üîå Apex API Methods

#### M√©todos P√∫blicos (@AuraEnabled)
- `syncProductsOnly()` - Sincronizar solo productos
- `syncCustomersOnly()` - Sincronizar solo clientes
- `syncOrdersOnly()` - Sincronizar solo √≥rdenes
- `syncHistoricalDataFromShopify()` - Sincronizaci√≥n completa
- `limpiarBaseDeDatos()` - Limpiar datos existentes
- `getShopifyProducts()` - Obtener productos (LWC)
- `getShopifyCustomers()` - Obtener clientes (LWC)
- `getShopifyOrders()` - Obtener √≥rdenes (LWC)

#### M√©todos Privados
- `getShopCurrency()` - Obtener moneda de la tienda
- `getProductsSimple()` - Obtener productos con query simple
- `getRealPricesFromShopify()` - Obtener precios reales
- `createPriceBookEntriesWithPrices()` - Crear Price Book Entries

## üìä Objetos y Campos Personalizados

### üè∑Ô∏è Campos Personalizados

#### Product2
- **ShopifyProductId__c** (Text, External ID, Unique)
  - ID √∫nico del producto en Shopify
  - Usado para sincronizaci√≥n y deduplicaci√≥n

#### Account
- **ShopifyCustomerId__c** (Text, External ID, Unique)
  - ID √∫nico del cliente en Shopify
  - Usado para sincronizaci√≥n y deduplicaci√≥n

#### Contact
- **ShopifyCustomerId__c** (Text, External ID, Unique)
  - ID √∫nico del cliente en Shopify
  - Usado para sincronizaci√≥n y deduplicaci√≥n

#### Order
- **ShopifyOrderId__c** (Text, External ID, Unique)
  - ID √∫nico de la orden en Shopify
- **ShopifyOrderNumber__c** (Text)
  - N√∫mero de orden de Shopify
- **ShopifyTotalAmount__c** (Currency)
  - Monto total de la orden
- **ShopifyFinancialStatus__c** (Text)
  - Estado financiero de la orden

### üîó Relaciones

- **Account ‚Üî Contact**: Relaci√≥n est√°ndar de Salesforce
- **Account ‚Üî Order**: Relaci√≥n est√°ndar de Salesforce
- **Product2 ‚Üî PricebookEntry**: Relaci√≥n est√°ndar de Salesforce

## üîÑ Flujo de Sincronizaci√≥n

### üìà Diagrama de Flujo

```mermaid
flowchart TD
    A[Iniciar Sincronizaci√≥n] --> B{¬øQu√© sincronizar?}
    
    B -->|Productos| C[Obtener Moneda]
    B -->|Clientes| D[Extraer Clientes]
    B -->|√ìrdenes| E[Extraer √ìrdenes]
    B -->|Todo| F[Sincronizaci√≥n Completa]
    
    C --> G[Extraer Productos]
    G --> H[Obtener Precios Reales]
    H --> I[Crear Product2]
    I --> J[Crear Price Book Entries]
    
    D --> K[Crear Account]
    K --> L[Crear Contact]
    
    E --> M[Buscar Account por Email]
    M --> N[Crear Order]
    
    F --> O[Ejecutar Todos los Flujos]
    
    J --> P[‚úÖ Completado]
    L --> P
    N --> P
    O --> P
```

### ‚ö° Optimizaciones

1. **Callouts Antes de DML**: Los callouts se ejecutan antes de las operaciones DML para evitar errores de transacci√≥n
2. **Upsert por External ID**: Uso de campos External ID para deduplicaci√≥n autom√°tica
3. **Batch Processing**: Procesamiento en lotes para mejor rendimiento
4. **Error Handling**: Manejo robusto de errores con logging detallado

## üõ†Ô∏è Desarrollo y Testing

### üß™ Testing

#### Pruebas Unitarias
```bash
sf apex run test --class-names ShopifyDataControllerTest --target-org shopifyOrg
```

#### Pruebas de Integraci√≥n
1. **Probar Conexi√≥n**: Verificar conectividad con Shopify
2. **Probar Sincronizaci√≥n**: Ejecutar sincronizaci√≥n de prueba
3. **Verificar Datos**: Confirmar que los datos se crean correctamente

### üîß Desarrollo

#### Estructura de Archivos
```
force-app/main/default/
‚îú‚îÄ‚îÄ classes/                    # Apex Classes
‚îÇ   ‚îú‚îÄ‚îÄ ShopifyDataController.cls
‚îÇ   ‚îú‚îÄ‚îÄ ShopifySyncService.cls
‚îÇ   ‚îú‚îÄ‚îÄ ShopifyToCoreMapper.cls
‚îÇ   ‚îî‚îÄ‚îÄ ShopifyWebhookHandler.cls
‚îú‚îÄ‚îÄ lwc/                       # Lightning Web Components
‚îÇ   ‚îú‚îÄ‚îÄ shopifyDashboard/
‚îÇ   ‚îú‚îÄ‚îÄ shopifyProducts/
‚îÇ   ‚îú‚îÄ‚îÄ shopifyCustomers/
‚îÇ   ‚îî‚îÄ‚îÄ shopifyOrders/
‚îú‚îÄ‚îÄ objects/                   # Custom Objects & Fields
‚îÇ   ‚îú‚îÄ‚îÄ Product2/fields/
‚îÇ   ‚îú‚îÄ‚îÄ Account/fields/
‚îÇ   ‚îú‚îÄ‚îÄ Contact/fields/
‚îÇ   ‚îî‚îÄ‚îÄ Order/fields/
‚îú‚îÄ‚îÄ namedCredentials/          # API Credentials
‚îî‚îÄ‚îÄ remoteSiteSettings/        # Remote Site Settings
```

#### Comandos de Desarrollo
```bash
# Desplegar cambios
sf project deploy start --target-org shopifyOrg

# Desplegar componente espec√≠fico
sf project deploy start --source-dir force-app/main/default/lwc/shopifyDashboard --target-org shopifyOrg

# Ejecutar tests
sf apex run test --target-org shopifyOrg

# Ver logs
sf apex log tail --target-org shopifyOrg
```

## üìà Monitoreo y Logs

### üîç Debug Logs

El sistema incluye logging extensivo para monitoreo y debugging:

#### Niveles de Log
- **üîÑ INICIANDO**: Inicio de operaciones
- **üìä PROCESANDO**: Procesamiento de datos
- **‚úÖ EXITOSO**: Operaciones completadas
- **‚ùå ERROR**: Errores y excepciones
- **üí∞ PRECIOS**: Informaci√≥n de precios
- **üì¶ PRODUCTOS**: Informaci√≥n de productos

#### Ver Logs
```bash
# Ver logs en tiempo real
sf apex log tail --target-org shopifyOrg --debug-level DEBUG

# Ver logs espec√≠ficos
sf apex log get --log-id <log-id> --target-org shopifyOrg
```

### üìä M√©tricas de Rendimiento

- **Tiempo de Sincronizaci√≥n**: Tiempo total de sincronizaci√≥n
- **Registros Procesados**: N√∫mero de registros sincronizados
- **Errores**: N√∫mero y tipo de errores
- **Precios Extra√≠dos**: N√∫mero de precios reales obtenidos

## üîí Seguridad

### üõ°Ô∏è Medidas de Seguridad

1. **Credenciales Seguras**: Uso de Named Credentials para autenticaci√≥n
2. **Validaci√≥n de Datos**: Validaci√≥n de entrada en todos los m√©todos
3. **Manejo de Errores**: No exposici√≥n de informaci√≥n sensible en errores
4. **Permisos de Usuario**: Control de acceso basado en permisos de Salesforce
5. **HTTPS**: Todas las comunicaciones usan HTTPS

### üîê Configuraci√≥n de Seguridad

1. **Remote Site Settings**: Configurar URLs permitidas
2. **Named Credentials**: Configurar autenticaci√≥n segura
3. **Permisos de Usuario**: Asignar permisos apropiados
4. **Validaci√≥n de Webhooks**: Validar firmas de webhooks

## ‚ùì Troubleshooting

### üö® Problemas Comunes

#### Error: "You have uncommitted work pending"
**Causa**: Intentar hacer callout despu√©s de operaciones DML
**Soluci√≥n**: Los callouts se ejecutan antes de las operaciones DML

#### Error: "Script-thrown exception"
**Causa**: Error en parsing de respuesta GraphQL
**Soluci√≥n**: Verificar sintaxis de queries GraphQL

#### Error: "500 Server Error"
**Causa**: Query GraphQL inv√°lida o problema de conectividad
**Soluci√≥n**: Verificar conectividad y sintaxis de queries

#### Precios en $0.00
**Causa**: No se extraen precios reales de Shopify
**Soluci√≥n**: Verificar query de variantes y parsing de precios

### üîß Soluciones

1. **Verificar Conectividad**: Comprobar Remote Site Settings
2. **Revisar Logs**: Usar Debug Logs para identificar problemas
3. **Validar Credenciales**: Verificar API Key de Shopify
4. **Probar Queries**: Usar herramientas de GraphQL para probar queries

### üìû Soporte

Para soporte t√©cnico:
1. Revisar logs de debug
2. Verificar configuraci√≥n
3. Consultar documentaci√≥n de Shopify API
4. Contactar al equipo de desarrollo

## üìù Changelog

### Version 1.0.0 (2025-01-27)

#### ‚ú® Nuevas Caracter√≠sticas
- Integraci√≥n completa Shopify-Salesforce
- Sincronizaci√≥n de productos con precios reales
- Sincronizaci√≥n de clientes a Account + Contact
- Sincronizaci√≥n de √≥rdenes
- Dashboard de gesti√≥n completo
- Lightning Web Components responsivos
- Sistema de logging extensivo

#### üîß Mejoras T√©cnicas
- Uso de GraphQL API de Shopify
- Objetos nativos de Salesforce
- Manejo robusto de errores
- Transacciones seguras
- C√≥digo modular y mantenible

#### üêõ Correcciones
- Error de "uncommitted work pending"
- Parsing de precios de variantes
- Sincronizaci√≥n de precios reales
- Refresco autom√°tico de interfaz

---

**¬°Gracias por usar la Integraci√≥n Shopify-Salesforce! üöÄ**
